---
layout: post
title: "JVM snapshot tests with selfie"
permalink: /selfie/
date: 2025-11-23T21:16:00.392+00:00
---

I'm a big fan of snapshot testing.
Snapshots are great to avoid manually writing a bunch of assertions.
You just pass in the `actual` object and let the snapshot library produce the `expected` result.
With traditional assertions, your tests are only as good as the fields you assert against.
But snapshot tests tend to capture _everything_or at least a lot more than a human writing assertions would.
So you often catch issues in fields that you wouldn't ordinarily. 

I've used Jest's snapshot tests for years.
And now there's a way to run snapshot tests on the JVM üôå.
All thanks to [selfie](https://selfie.dev/).

[![]({{ "/assets/2025-11-23-selfie.png" | relative_url }})](https://selfie.dev/)

üóíÔ∏è Tests performed using JDK21 (Corretto), Kotlin v2.2.20, and selfie-runner-junit5 v2.5.0.

## Inline snapshots

My favourite kind of snapshot tests are inline ones.
I love grouping the snapshots with the code making the assertion. 
Selfie supports these just fine.

{% capture inline_snapshot_before %}
```kotlin
@Test
fun `test inline snapshot`() {
    Selfie.expectSelfie(listOf(1, 2, 3).toString()).toBe_TODO()
}
```
{% endcapture %}

{% capture inline_snapshot_after %}
```kotlin
@Test
fun `test inline snapshot`() {
    Selfie.expectSelfie(listOf(1, 2, 3).toString()).toBe("[1, 2, 3]")
}
```
{% endcapture %}

{% include tabs.html 
  id="inline-snapshot"
  tab1="Before"
  tab1_content=inline_snapshot_before
  tab2="After"
  tab2_content=inline_snapshot_after
%}

## Disk snapshots

Disk snapshots work exactly as you'd expect.

{% capture file_snapshot_before %}
```kotlin
@Test
fun `test disk snapshot`() {
    Selfie.expectSelfie(listOf("a", "b", "c").toString()).toMatchDisk_TODO()
}
```
{% endcapture %}

{% capture file_snapshot_after %}
```kotlin
@Test
fun `test disk snapshot`() {
    Selfie.expectSelfie(listOf("a", "b", "c").toString()).toMatchDisk()
}
```

The file is placed in the same directory as the test, and is named after the test class.
So in `SnapshotTest.ss` we find:

```
‚ïî‚ïê testDiskSnapshot ‚ïê‚ïó
[a, b, c]
‚ïî‚ïê [end of file] ‚ïê‚ïó
```
{% endcapture %}

{% include tabs.html 
  id="file-snapshot"
  tab1="Before"
  tab1_content=file_snapshot_before
  tab2="After"
  tab2_content=file_snapshot_after
%}

## Updating snapshots

As you iterate on your code, you'll need to update your existing snapshots to match new expectations.
Selfie provides _a bunch_ of different ways to do this.

### Delete the snapshot and add `_TODO` back

The is the most basic way of updating snapshots.
You just delete the existing snapshot and add `_TODO` back to the tests.
But this will quickly become laborious and time consuming.

So you turn this:

```kotlin
@Test
fun `test inline snapshot`() {
    Selfie.expectSelfie(listOf(1, 2, 3).toString()).toBe("[1, 2, 3]")
}
```

back in to this:

```kotlin
@Test
fun `test inline snapshot`() {
    Selfie.expectSelfie(listOf(1, 2, 3).toString()).toBe_TODO()
}
```

And then re-run the tests.

### Via the `selfie`/`SELFIE` environment variable / system propety.

Probably my favourite method is to just re-run the test suite and tell selfie to update all snapshots.

```bash
./gradlew test -Pselfie=overwrite
# or
SELFIE=overwrite ./gradlew test
```

I like this method because it matches how I update Jest snapshots (`npm run test -- --updateSnapshot`).
You can use your version control to see which snapshots have changed and revert the snapshots back if they don't look right.

### With the `//selfieonce` magic comment

Adding this comment into the test file will cause selfie to overwrite the snapshots in the file and then remove the comment.

### With the `//SELFIEWRITE` magic comment

The same as above but the comment will stay there. Subsequent test runs will overwrite the snapshots.

## Use `SelfieSettingsAPI` to write custom formatters

In much the same way that AssertJ lets your write custom assertions, selfie lets you write custom snapshot serializers.
In the following example, I've written a serializer that makes string lists look like markdown.

```kotlin
object CustomSelfie : SelfieSettingsAPI() {
    fun expectSelfie(response: List<String>): StringSelfie {
        return expectSelfie(response) {
            Snapshot.of(it.joinToString(
                prefix = "\n", 
                separator = "\n", 
                postfix = "\n"
            ) { item -> "- $item" })
        }
    }
}
```

{% capture custom_serializer_snapshot_before %}
```kotlin
@Test
fun `test custom serializer`() {
    CustomSelfie.expectSelfie(listOf("a", "b", "c")).toBe_TODO()
}
```
{% endcapture %}

{% capture custom_serializer_snapshot_after %}
```kotlin
@Test
fun `test custom serializer`() {
    CustomSelfie.expectSelfie(listOf("a", "b", "c")).toBe("""
- a
- b
- c
""")
}
```

Unfortunately, selfie doesn't give you pretty indentation using Kotlin's `trimIndent` (yet!).
{% endcapture %}

{% include tabs.html 
  id="custom-serializer-snapshot"
  tab1="Before"
  tab1_content=custom_serializer_snapshot_before
  tab2="After"
  tab2_content=custom_serializer_snapshot_after
%}